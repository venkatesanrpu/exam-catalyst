{{!
    FILE: blocks/ai_assistant/templates/history_widget.mustache
    PURPOSE: Modal overlay for viewing chat history
    NOTE: Gets config from parent main.mustache context
}}

<!-- History Modal Overlay -->
<div id="ai-assistant-history-modal" class="ai-assistant-history-modal" style="display: none;">
    <div class="ai-assistant-history-modal-content">
        
        <!-- Header -->
        <div class="ai-assistant-history-modal-header">
            <h3>üìú Chat History</h3>
            <button id="ai-assistant-history-close" class="ai-assistant-history-close-button" aria-label="Close history">
                &times;
            </button>
        </div>
        
        <!-- Filter Selection -->
        <div class="ai-assistant-history-filters">
            <div class="filter-group">
                <label for="history-subject">Subject</label>
                <select id="history-subject" class="form-select">
                    <option value="">-- Select Subject --</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="history-topic">Topic</label>
                <select id="history-topic" class="form-select" disabled>
                    <option value="">-- Select Topic --</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="history-lesson">Lesson</label>
                <select id="history-lesson" class="form-select" disabled>
                    <option value="">-- Select Lesson --</option>
                </select>
            </div>
            
            <button id="history-load-button" class="btn btn-primary" disabled>
                View History
            </button>
        </div>
        
        <!-- History Display Area -->
        <div id="ai-assistant-history-body" class="ai-assistant-history-body">
            <div class="empty-state">
                <p>üìö Select a lesson above to view your conversation history</p>
            </div>
        </div>
        
        <!-- Pagination -->
        <div id="ai-assistant-history-pagination" class="ai-assistant-history-pagination" style="display: none;"></div>
        
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // Check if already initialized
    if (window.aiAssistantHistoryWidgetInitialized) {
        console.log('‚ö†Ô∏è History Widget already initialized');
        return;
    }
    
    console.log('üîß Initializing History Widget...');
    
    // ==================== DOM ELEMENTS ====================
    const modal = document.getElementById('ai-assistant-history-modal');
    const closeButton = document.getElementById('ai-assistant-history-close');
    const historyBody = document.getElementById('ai-assistant-history-body');
    const subjectSelect = document.getElementById('history-subject');
    const topicSelect = document.getElementById('history-topic');
    const lessonSelect = document.getElementById('history-lesson');
    const loadButton = document.getElementById('history-load-button');
    const pagination = document.getElementById('ai-assistant-history-pagination');
    
    if (!modal || !closeButton || !historyBody) {
        console.error('‚ùå History Widget: Required DOM elements not found');
        return;
    }
    
    // ==================== STATE ====================
    let currentPage = 1;
    let syllabusData = null;
    const courseid = {{courseid}};
    const sesskey = '{{sesskey}}';
	const historyAjaxUrl = '{{historywidgetajaxurl}}';  // ‚úÖ ADD THIS
    
    // ==================== RENDERING UTILITIES ====================
    const markdown = window.markdownit ? window.markdownit({
        html: true,
        breaks: true
    }) : null;
    
    const renderLatex = (text) => {
        if (!window.katex) {
            console.warn('KaTeX not loaded');
            return { text, placeholders: new Map() };
        }
        
        const latexPlaceholders = new Map();
        
        // Display math: \[ ... \]
        text = text.replace(/\\\[([\s\S]*?)\\\]/g, (match, latex) => {
            try {
                const rendered = katex.renderToString(latex.trim(), { displayMode: true, throwOnError: false });
                const placeholder = `@@KATEX_DISPLAY_${latexPlaceholders.size}@@`;
                latexPlaceholders.set(placeholder, rendered);
                return placeholder;
            } catch (e) {
                console.error('KaTeX display error:', e);
                return match;
            }
        });
        
        // Inline math: \( ... \)
        text = text.replace(/\\\(([\s\S]*?)\\\)/g, (match, latex) => {
            try {
                const rendered = katex.renderToString(latex.trim(), { displayMode: false, throwOnError: false });
                const placeholder = `@@KATEX_INLINE_${latexPlaceholders.size}@@`;
                latexPlaceholders.set(placeholder, rendered);
                return placeholder;
            } catch (e) {
                console.error('KaTeX inline error:', e);
                return match;
            }
        });
        
        return { text, placeholders: latexPlaceholders };
    };
    
    // ==================== CASCADING DROPDOWNS ====================
    
    // Populate subjects
    const populateSubjects = () => {
        if (!syllabusData || !Array.isArray(syllabusData)) {
            console.error('‚ùå Invalid syllabus data');
            subjectSelect.innerHTML = '<option value="">No subjects available</option>';
            return;
        }
        
        console.log('üìö Populating subjects:', syllabusData.length);
        subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
        
        syllabusData.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject.subject_key;
            option.textContent = subject.subject;
            subjectSelect.appendChild(option);
        });
    };
    
    // Subject change handler
    subjectSelect.addEventListener('change', () => {
        const selectedSubjectKey = subjectSelect.value;
        
        // Reset topic and lesson
        topicSelect.innerHTML = '<option value="">-- Select Topic --</option>';
        lessonSelect.innerHTML = '<option value="">-- Select Lesson --</option>';
        topicSelect.disabled = true;
        lessonSelect.disabled = true;
        loadButton.disabled = true;
        
        if (!selectedSubjectKey) return;
        
        // Find subject data
        const subjectData = syllabusData.find(s => s.subject_key === selectedSubjectKey);
        
        if (subjectData && subjectData.topics && Array.isArray(subjectData.topics)) {
            console.log('üìã Populating topics:', subjectData.topics.length);
            
            subjectData.topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic.topic_key;
                option.textContent = topic.topic;
                topicSelect.appendChild(option);
            });
            
            topicSelect.disabled = false;
        }
    });
    
    // Topic change handler
    topicSelect.addEventListener('change', () => {
        const selectedSubjectKey = subjectSelect.value;
        const selectedTopicKey = topicSelect.value;
        
        // Reset lesson
        lessonSelect.innerHTML = '<option value="">-- Select Lesson --</option>';
        lessonSelect.disabled = true;
        loadButton.disabled = true;
        
        if (!selectedTopicKey) return;
        
        // Find subject and topic data
        const subjectData = syllabusData.find(s => s.subject_key === selectedSubjectKey);
        const topicData = subjectData ? subjectData.topics.find(t => t.topic_key === selectedTopicKey) : null;
        
        if (topicData && topicData.lessons && Array.isArray(topicData.lessons)) {
            console.log('üìñ Populating lessons:', topicData.lessons.length);
            
            topicData.lessons.forEach(lesson => {
                const option = document.createElement('option');
                
                // Handle both string and object lessons
                if (typeof lesson === 'string') {
                    option.value = lesson;
                    option.textContent = lesson;
                } else if (lesson.lesson) {
                    option.value = lesson.lesson;
                    option.textContent = lesson.lesson;
                }
                
                lessonSelect.appendChild(option);
            });
            
            lessonSelect.disabled = false;
        }
    });
    
    // Lesson change handler
    lessonSelect.addEventListener('change', () => {
        loadButton.disabled = !lessonSelect.value;
    });
    
    // ==================== FETCH HISTORY ====================
    const fetchHistory = async (subjectKey, topicKey, lesson) => {
        historyBody.innerHTML = '<div class="loading">‚è≥ Loading conversations...</div>';
        
        try {
            const response = await fetch(historyAjaxUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sesskey: sesskey,
                    courseid: courseid,
                    subject: subjectKey,
                    topic: topicKey,
                    lesson: lesson,
                    page: currentPage,
                    perpage: 20
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.status === 'error') {
                throw new Error(data.message || 'Failed to fetch history');
            }
            
            if (data.conversations && data.conversations.length > 0) {
                console.log('‚úÖ Loaded', data.conversations.length, 'conversations');
                renderHistoryAccordion(data.conversations);
            } else {
                historyBody.innerHTML = '<div class="empty-state"><p>üì≠ No conversations found for this lesson.</p></div>';
            }
        } catch (error) {
            console.error('‚ùå Failed to fetch history:', error);
            historyBody.innerHTML = '<div class="error">‚ùå Failed to load history. Please try again.</div>';
        }
    };
    
    // ==================== RENDER ACCORDION ====================
    const renderHistoryAccordion = (conversations) => {
        historyBody.innerHTML = '';
        
        conversations.forEach((conv, index) => {
            const accordionItem = document.createElement('div');
            accordionItem.className = 'accordion-item';
            
            // Truncate user text for header
            const truncatedText = conv.usertext.length > 80 
                ? conv.usertext.substring(0, 80) + '...' 
                : conv.usertext;
            
            accordionItem.innerHTML = `
                <div class="accordion-header" data-index="${index}">
                    <div>
                        <strong>${conv.formattedtime}:</strong> ${truncatedText}
                    </div>
                    <span style="color: #6c757d;">‚ñº</span>
                </div>
                <div class="accordion-content" style="display: none;">
                    <div class="message user-message">
                        <div class="avatar">U</div>
                        <div class="content">${conv.usertext}</div>
                    </div>
                    <div class="message bot-message">
                        <div class="avatar">A</div>
                        <div class="content" data-rendered="false">${conv.botresponse}</div>
                    </div>
                </div>
            `;
            
            // Lazy render on expand
            const header = accordionItem.querySelector('.accordion-header');
            const content = accordionItem.querySelector('.accordion-content');
            const botContent = accordionItem.querySelector('.bot-message .content');
            const arrow = header.querySelector('span');
            
            header.addEventListener('click', () => {
                const isVisible = content.style.display === 'block';
                
                // Toggle visibility
                content.style.display = isVisible ? 'none' : 'block';
                arrow.textContent = isVisible ? '‚ñº' : '‚ñ≤';
                
                // Render LaTeX/Markdown on first expand
                if (!isVisible && botContent.dataset.rendered === 'false') {
                    const { text, placeholders } = renderLatex(botContent.innerHTML);
                    let rendered = markdown ? markdown.render(text) : text;
                    
                    placeholders.forEach((html, placeholder) => {
                        const escapedPlaceholder = placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        rendered = rendered.replace(new RegExp(escapedPlaceholder, 'g'), html);
                    });
                    
                    botContent.innerHTML = rendered;
                    botContent.dataset.rendered = 'true';
                }
            });
            
            historyBody.appendChild(accordionItem);
        });
    };
    
    // ==================== LOAD BUTTON HANDLER ====================
    loadButton.addEventListener('click', () => {
        const subjectKey = subjectSelect.value;
        const topicKey = topicSelect.value;
        const lesson = lessonSelect.value;
        
        if (subjectKey && topicKey && lesson) {
            console.log('üîç Fetching history for:', { subjectKey, topicKey, lesson });
            fetchHistory(subjectKey, topicKey, lesson);
        } else {
            alert('Please select subject, topic, and lesson');
        }
    });
    
    // ==================== MODAL CONTROLS ====================
    window.openHistoryWidget = function() {
        console.log('üìú Opening History Widget...');
        modal.style.display = 'flex';
        
        // Load syllabus if not already loaded
        if (!syllabusData) {
            loadSyllabus();
        }
    };
    
    window.closeHistoryWidget = function() {
        console.log('‚ùå Closing History Widget...');
        modal.style.display = 'none';
        historyBody.innerHTML = '<div class="empty-state"><p>üìö Select a lesson above to view your conversation history</p></div>';
        pagination.style.display = 'none';
    };
    
    const loadSyllabus = async () => {
        // Try to get syllabus from main widget first
        if (window.aiAssistantState && window.aiAssistantState.syllabusData) {
            console.log('‚úÖ Using syllabus from main widget');
            syllabusData = window.aiAssistantState.syllabusData;
            populateSubjects();
            return;
        }
        
        console.log('‚è≥ Waiting for syllabus to load...');
        subjectSelect.innerHTML = '<option value="">Loading subjects...</option>';
    };
    
    // Listen for syllabus loaded event from main widget
    document.addEventListener('syllabusLoaded', (e) => {
        console.log('üì• Received syllabus data from main widget');
        syllabusData = e.detail.syllabusData;
        populateSubjects();
    });
    
    // ==================== EVENT HANDLERS ====================
    closeButton.addEventListener('click', window.closeHistoryWidget);
    
    // Close on overlay click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            window.closeHistoryWidget();
        }
    });
    
    // Close on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
            window.closeHistoryWidget();
        }
    });
    
    console.log('‚úÖ History Widget initialized');
    window.aiAssistantHistoryWidgetInitialized = true;
    
})();
</script>
