{{!
    FILE: blocks/ai_assistant/templates/history_widget.mustache
    PURPOSE: Modal overlay for viewing chat history
    NOTE: Gets config from parent main.mustache context
}}

<!-- History Modal Overlay -->
<div id="ai-assistant-history-modal" class="ai-assistant-history-modal" style="display: none;">
    <div class="ai-assistant-history-modal-content">
        
        <!-- Header -->
        <div class="ai-assistant-history-modal-header">
            <h3>üìú Chat History</h3>
            <button id="ai-assistant-history-close" class="ai-assistant-history-close-button" aria-label="Close history">
                &times;
            </button>
        </div>
        
        <!-- Filter Selection -->
        <div class="ai-assistant-history-filters">
            <div class="filter-group">
                <label for="history-subject">Subject</label>
                <select id="history-subject" class="form-select">
                    <option value="">-- Select Subject --</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="history-topic">Topic</label>
                <select id="history-topic" class="form-select" disabled>
                    <option value="">-- Select Topic --</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="history-lesson">Lesson</label>
                <select id="history-lesson" class="form-select" disabled>
                    <option value="">-- Select Lesson --</option>
                </select>
            </div>
            
            <button id="history-load-button" class="btn btn-primary" disabled>
                View History
            </button>
        </div>
        
        <!-- History Display Area -->
        <div id="ai-assistant-history-body" class="ai-assistant-history-body">
            <div class="empty-state">
                <p>üìö Select a lesson above to view your conversation history</p>
            </div>
        </div>
        
        <!-- Pagination -->
        <div id="ai-assistant-history-pagination" class="ai-assistant-history-pagination" style="display: none;"></div>
        
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // Check if already initialized
    if (window.aiAssistantHistoryWidgetInitialized) {
        console.log('‚ö†Ô∏è History Widget already initialized');
        return;
    }
    
    console.log('üîß Initializing History Widget...');
    
    // ==================== DOM ELEMENTS ====================
    const modal = document.getElementById('ai-assistant-history-modal');
    const closeButton = document.getElementById('ai-assistant-history-close');
    const historyBody = document.getElementById('ai-assistant-history-body');
    const subjectSelect = document.getElementById('history-subject');
    const topicSelect = document.getElementById('history-topic');
    const lessonSelect = document.getElementById('history-lesson');
    const loadButton = document.getElementById('history-load-button');
    const pagination = document.getElementById('ai-assistant-history-pagination');
    
    if (!modal || !closeButton || !historyBody) {
        console.error('‚ùå History Widget: Required DOM elements not found');
        return;
    }
    
    // ==================== STATE ====================
    let currentPage = 1;
    let syllabusData = null;
    
    // ==================== RENDERING UTILITIES ====================
    const markdown = window.markdownit ? window.markdownit({
        html: true,
        breaks: true
    }) : null;
    
    const renderLatex = (text) => {
        if (!window.katex) {
            console.warn('KaTeX not loaded');
            return { text, placeholders: new Map() };
        }
        
        const latexPlaceholders = new Map();
        
        // Display math: \[ ... \]
        text = text.replace(/\\\[([\s\S]*?)\\\]/g, (match, latex) => {
            try {
                const rendered = katex.renderToString(latex.trim(), { displayMode: true, throwOnError: false });
                const placeholder = `@@KATEX_DISPLAY_${latexPlaceholders.size}@@`;
                latexPlaceholders.set(placeholder, rendered);
                return placeholder;
            } catch (e) {
                console.error('KaTeX display error:', e);
                return match;
            }
        });
        
        // Inline math: \( ... \)
        text = text.replace(/\\\(([\s\S]*?)\\\)/g, (match, latex) => {
            try {
                const rendered = katex.renderToString(latex.trim(), { displayMode: false, throwOnError: false });
                const placeholder = `@@KATEX_INLINE_${latexPlaceholders.size}@@`;
                latexPlaceholders.set(placeholder, rendered);
                return placeholder;
            } catch (e) {
                console.error('KaTeX inline error:', e);
                return match;
            }
        });
        
        return { text, placeholders: latexPlaceholders };
    };
    
    // ==================== MODAL CONTROLS ====================
    window.openHistoryWidget = function() {
        console.log('üìú Opening History Widget...');
        modal.style.display = 'flex';
        
        // Load syllabus if not already loaded
        if (!syllabusData) {
            loadSyllabus();
        }
    };
    
    window.closeHistoryWidget = function() {
        console.log('‚ùå Closing History Widget...');
        modal.style.display = 'none';
        historyBody.innerHTML = '<div class="empty-state"><p>üìö Select a lesson above to view your conversation history</p></div>';
        pagination.style.display = 'none';
    };
    
    // ==================== LOAD SYLLABUS ====================
    const loadSyllabus = async () => {
        // Try to get syllabus from main widget first
        if (window.aiAssistantState && window.aiAssistantState.syllabusData) {
            console.log('‚úÖ Using syllabus from main widget');
            syllabusData = window.aiAssistantState.syllabusData;
            populateSubjects();
            return;
        }
        
        console.log('‚è≥ Loading syllabus data...');
        // If not available, we'll populate subjects when main widget loads it
        // For now, show a message
        subjectSelect.innerHTML = '<option value="">Loading subjects...</option>';
    };
	
	// ‚úÖ NEW: Listen for syllabus loaded event from main widget
document.addEventListener('syllabusLoaded', (e) => {
  console.log('üì• Received syllabus data from main widget');
  syllabusData = e.detail.syllabusData;
  populateSubjects();
});
    
    const populateSubjects = () => {
        if (!syllabusData || !Array.isArray(syllabusData)) {
            console.error('‚ùå Invalid syllabus data');
            subjectSelect.innerHTML = '<option value="">No subjects available</option>';
            return;
        }
        
        console.log('üìö Populating subjects:', syllabusData.length);
        subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
        
        syllabusData.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject.subject_key;
            option.textContent = subject.subject;
            subjectSelect.appendChild(option);
        });
    };
    
    // ==================== EVENT HANDLERS ====================
    closeButton.addEventListener('click', window.closeHistoryWidget);
    
    // Close on overlay click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            window.closeHistoryWidget();
        }
    });
    
    // Close on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
            window.closeHistoryWidget();
        }
    });
    
    console.log('‚úÖ History Widget initialized');
    window.aiAssistantHistoryWidgetInitialized = true;
    
})();
</script>
